AWSTemplateFormatVersion: '2010-09-09'
Description: 'AWS App Runner Service for Polaris Backend'

Parameters:
  RepositoryUrl:
    Type: String
    Description: GitHub repository URL
    Default: 'https://github.com/umair2602/polaris-rfp.git'
  
  BranchName:
    Type: String
    Description: Branch name to deploy
    Default: 'main'
  
  Environment:
    Type: String
    Description: Environment name
    Default: 'production'
    AllowedValues: ['development', 'staging', 'production']

Resources:

  # IAM Role for App Runner
  AppRunnerInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: tasks.apprunner.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess
        - arn:aws:iam::aws:policy/CloudWatchLogsFullAccess

  # IAM Role for App Runner Service
  AppRunnerServiceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: build.apprunner.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AppRunnerServicePolicyForECRAccess
        - arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess

  # CloudWatch Log Group for App Runner
  AppRunnerLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub '/aws/apprunner/${AWS::StackName}'
      RetentionInDays: 14

  # App Runner Service
  BackendAppRunnerService:
    Type: AWS::AppRunner::Service
    Properties:
      ServiceName: !Sub 'polaris-backend-${Environment}'
      SourceConfiguration:
        CodeRepository:
          RepositoryUrl: !Ref RepositoryUrl
          SourceCodeVersion:
            Type: BRANCH
            Value: !Ref BranchName
          CodeConfiguration:
            ConfigurationSource: REPOSITORY
            CodeConfigurationValues:
              Runtime: NODEJS_18
              BuildCommand: 'cd backend && npm ci --production'
              StartCommand: 'cd backend && npm start'
              RuntimeEnvironmentVariables:
                NODE_ENV: !Ref Environment
                PORT: '8000'
        AutoDeploymentsEnabled: true
        ServiceRoleArn: !GetAtt AppRunnerServiceRole.Arn
      InstanceConfiguration:
        Cpu: '1024'
        Memory: '2048'
        InstanceRoleArn: !GetAtt AppRunnerInstanceRole.Arn
      HealthCheckConfiguration:
        Protocol: HTTP
        Path: /
        Interval: 10
        Timeout: 5
        HealthyThreshold: 2
        UnhealthyThreshold: 5
      Tags:
        - Key: Environment
          Value: !Ref Environment
        - Key: Service
          Value: Backend

  # Auto Scaling Configuration
  AutoScalingConfiguration:
    Type: AWS::AppRunner::AutoScalingConfiguration
    Properties:
      AutoScalingConfigurationName: !Sub '${AWS::StackName}-autoscaling'
      MaxConcurrency: 100
      MaxSize: 10
      MinSize: 1
      Tags:
        - Key: Environment
          Value: !Ref Environment

Outputs:
  AppRunnerServiceUrl:
    Description: 'App Runner Service URL'
    Value: !GetAtt BackendAppRunnerService.ServiceUrl
    Export:
      Name: !Sub '${AWS::StackName}-AppRunnerServiceUrl'

  AppRunnerServiceArn:
    Description: 'App Runner Service ARN'
    Value: !GetAtt BackendAppRunnerService.ServiceArn
    Export:
      Name: !Sub '${AWS::StackName}-AppRunnerServiceArn'

